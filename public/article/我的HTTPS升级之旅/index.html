<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <link rel="alternate icon" type="image/jpg" href="//mares.oss-cn-qingdao.aliyuncs.com/avatar.jpg">
    <title>Lynx | å°ç†Šå†™å­—çš„åœ°æ–¹</title>
    <meta name="description" content="ç†Šè´¤ä»çš„ä¸ªäººåšå®¢">
    <meta name="keywords" content="Node.js,Vue,React,JavaScript,Git,è½¯ä»¶å¼€å‘,webå‰ç«¯,æŠ€æœ¯,ç¨‹åºå‘˜,æ€è€ƒ">
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/markdown.css">
    <link rel="stylesheet" href="/css/fonts.css">
<link rel="alternate" href="/atom.xml" title="Lynx" type="application/atom+xml">
</head>
    <body>
        <div class="paper">
            <div class="paper-main">
                
                    <div class="post-header">
    <a class="logo" href="/">Lynx</a>
    <a class="go-home" href="/">
        <svg width="8" height="14" viewBox="0 0 8 14">
            <path d="M7 1L1 7l6 6" stroke="#000" stroke-width="2" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </a>
</div>
                
                <div class="post-main">

    
        <div class="post-main-title">
            æˆ‘çš„ HTTPS å‡çº§ä¹‹æ—…
        </div>
        <div class="post-meta">
            2017-05-11
        </div>
    

    <div class="post-md">
        <blockquote>
<p>æœ¬æ–‡å°†ä»‹ç»æˆ‘æ˜¯å¦‚ä½•å°†ä¸€ä¸ª HTTP ç½‘ç«™å‡çº§åˆ° HTTPSã€‚ç³»ç»Ÿç¯å¢ƒï¼šCentOS 7.0 + Nginx 1.12.0</p>
</blockquote>
<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å…ˆè´´ä¸€ä¸ªç¦åˆ©ï¼Œä¹Ÿä½œä¸ºæ²¡æœ‰å¯ç”¨ HTTPS çš„åé¢æ•™æï¼š</p>
<p><img src="https://mares.oss-cn-qingdao.aliyuncs.com/blog/https-upgrade/1.png" alt="ç¦åˆ©.png"><br>è¿™æ˜¯æˆ‘å‚ä¸å¼€å‘è¿‡çš„ä¸€ä¸ªå¤–åŒ…ç½‘ç«™ï¼Œæ²¡æœ‰å¯ç”¨ HTTPSï¼Œç½‘ç«™é¡µé¢è¢«ä¸­é—´äººåŠ«æŒï¼Œå¹¶æ’å…¥äº†ä¸€äº›å¥‡æ€ªçš„ä¸œè¥¿ã€‚ä¸‹é¢æ˜¯æ­£æ–‡ã€‚</p>
<h1 id="é¢„å¤‡æ¡ä»¶"><a href="#é¢„å¤‡æ¡ä»¶" class="headerlink" title="é¢„å¤‡æ¡ä»¶"></a>é¢„å¤‡æ¡ä»¶</h1><p>æœ¬æ–‡å‡å®šä½ å·²ç»æ‹¥æœ‰ä¸€ä¸ªæ­£ç¡®è§£æåˆ°æœåŠ¡å™¨IPçš„åŸŸåï¼ŒæœåŠ¡å™¨ä¸Šå·²å®‰è£… Nginxã€‚Nginx å¯ä»¥é€šè¿‡æºç ç¼–è¯‘å®‰è£…ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç³»ç»Ÿæä¾›çš„åŒ…ç®¡ç†å™¨å®‰è£…ï¼Œæ¯”å¦‚ RH ç³»çš„ yum æˆ–è€… Debian ç³»çš„ apt-getï¼Œå…·ä½“æ­¥éª¤è‡ªè¡ŒGoogleã€‚</p>
<h1 id="è·å–è¯ä¹¦"><a href="#è·å–è¯ä¹¦" class="headerlink" title="è·å–è¯ä¹¦"></a>è·å–è¯ä¹¦</h1><p>HTTPS è¯ä¹¦åˆ†ä¸‰ç±»ï¼š1. DV åŸŸåéªŒè¯è¯ä¹¦ 2. OV ç»„ç»‡æœºæ„éªŒè¯è¯ä¹¦ 3. EV å¢å¼ºçš„ç»„ç»‡æœºæ„éªŒè¯è¯ä¹¦ã€‚æ¯ç±»è¯ä¹¦çš„å®¡æ ¸è¦æ±‚ä¸åŒï¼Œåœ¨æµè§ˆå™¨åœ°å€æ ä¹Ÿä¼šæœ‰åŒºåˆ†ï¼Œå¯¹äºä¸ªäººç½‘ç«™è€Œè¨€ï¼Œä½¿ç”¨å…è´¹çš„ DV è¯ä¹¦å°±è¶³å¤Ÿäº†ã€‚</p>
<p>æˆ‘ä½¿ç”¨äº†å¤§åé¼é¼çš„ Letâ€™s Encrypt æ¥ç”Ÿæˆè¯ä¹¦ã€‚</p>
<h2 id="1-å®‰è£…-certbot"><a href="#1-å®‰è£…-certbot" class="headerlink" title="1. å®‰è£… certbot"></a>1. å®‰è£… certbot</h2><p>certbot æ˜¯ Letâ€™s Encrypt æä¾›çš„ä¸€å¥—è‡ªåŠ¨åŒ–å·¥å…·ã€‚ </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install epel-release</span><br><span class="line">yum install certbot</span><br></pre></td></tr></table></figure>

<h2 id="2-ç”Ÿæˆè¯ä¹¦"><a href="#2-ç”Ÿæˆè¯ä¹¦" class="headerlink" title="2. ç”Ÿæˆè¯ä¹¦"></a>2. ç”Ÿæˆè¯ä¹¦</h2><p>è¿™é‡Œé‡‡ç”¨ webroot ä½œä¸º Letâ€™s Encrypt çš„è®¤è¯æ–¹å¼ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">certbot certonly -a webroot --webroot-path=/your/project/path -d example.com -d www.example.com</span><br></pre></td></tr></table></figure>

<p>webroot-pathå°±æ˜¯ä½ çš„é¡¹ç›®è·¯å¾„ï¼Œä½¿ç”¨ -d å¯ä»¥æ·»åŠ å¤šä¸ªåŸŸåã€‚è¿™æ—¶è¯ä¹¦å°±å·²ç»ç”ŸæˆæˆåŠŸäº†ï¼Œé»˜è®¤ä¿å­˜åœ¨ &#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;example.com&#x2F; ä¸‹ã€‚è¯ä¹¦æ–‡ä»¶åŒ…æ‹¬ï¼š</p>
<ul>
<li>cert.pem: æœåŠ¡ç«¯è¯ä¹¦</li>
<li>chain.pem: æµè§ˆå™¨éœ€è¦çš„æ‰€æœ‰è¯ä¹¦ä½†ä¸åŒ…æ‹¬æœåŠ¡ç«¯è¯ä¹¦ï¼Œæ¯”å¦‚æ ¹è¯ä¹¦å’Œä¸­é—´è¯ä¹¦</li>
<li>fullchain.pem: åŒ…æ‹¬äº†cert.pemå’Œchain.pemçš„å†…å®¹</li>
<li>privkey.pem: è¯ä¹¦ç§é’¥</li>
</ul>
<h2 id="3-ç”Ÿæˆè¿ªè²-èµ«å°”æ›¼å¯†é’¥äº¤æ¢ç»„ï¼ˆ-Strong-Diffie-Hellman-Groupï¼‰"><a href="#3-ç”Ÿæˆè¿ªè²-èµ«å°”æ›¼å¯†é’¥äº¤æ¢ç»„ï¼ˆ-Strong-Diffie-Hellman-Groupï¼‰" class="headerlink" title="3. ç”Ÿæˆè¿ªè²-èµ«å°”æ›¼å¯†é’¥äº¤æ¢ç»„ï¼ˆ Strong Diffie-Hellman Groupï¼‰"></a>3. ç”Ÿæˆè¿ªè²-èµ«å°”æ›¼å¯†é’¥äº¤æ¢ç»„ï¼ˆ Strong Diffie-Hellman Groupï¼‰</h2><p>ä¸ºäº†è¿›ä¸€æ­¥æé«˜å®‰å…¨æ€§ï¼Œä½ ä¹Ÿå¯ä»¥ç”Ÿæˆä¸€ä¸ª Strong Diffie-Hellman Groupã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ²¡æœ‰å®‰è£… opensslï¼Œè¿™é‡Œè¦å…ˆå®‰è£…ä¸€ä¸‹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install openssl</span><br></pre></td></tr></table></figure>

<h1 id="é…ç½®-Nginx"><a href="#é…ç½®-Nginx" class="headerlink" title="é…ç½® Nginx"></a>é…ç½® Nginx</h1><p>ç¼–è¾‘ Nginx é…ç½®æ–‡ä»¶ï¼Œå¦‚æœä½ ä¸çŸ¥é“é…ç½®æ–‡ä»¶åœ¨å“ªï¼Œå¯ä»¥ç”¨ locate &#x2F;nginx.conf å‘½ä»¤æŸ¥æ‰¾ã€‚æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼Œå…·ä½“å‚æ•°ä»¥ä½ çš„å®é™…æƒ…å†µä¸ºå‡†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    # å¯ç”¨http2</span><br><span class="line">    # éœ€è¦å®‰è£… Nginx Http2 Module</span><br><span class="line">    # listen 443 http2 ssl;</span><br><span class="line">    server_name example.com www.example.com;</span><br><span class="line">    #è¯ä¹¦æ–‡ä»¶</span><br><span class="line">    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;</span><br><span class="line">    #ç§é’¥æ–‡ä»¶</span><br><span class="line">    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;</span><br><span class="line"></span><br><span class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">    # ä¼˜å…ˆé‡‡å–æœåŠ¡å™¨ç®—æ³•</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line">    # å®šä¹‰ç®—æ³•</span><br><span class="line">    ssl_ciphers &quot;EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH&quot;;</span><br><span class="line">    ssl_ecdh_curve secp384r1;</span><br><span class="line">    ssl_session_cache shared:SSL:10m;</span><br><span class="line">    ssl_session_tickets off;</span><br><span class="line">    ssl_stapling on;</span><br><span class="line">    ssl_stapling_verify on;</span><br><span class="line">    resolver 8.8.8.8 8.8.4.4 valid=300s;</span><br><span class="line">    resolver_timeout 5s;</span><br><span class="line">   </span><br><span class="line">    add_header Strict-Transport-Security &quot;max-age=63072000; includeSubdomains&quot;;</span><br><span class="line">    add_header X-Frame-Options DENY;</span><br><span class="line">    add_header X-Content-Type-Options nosniff;</span><br><span class="line">    # ä½¿ç”¨DHæ–‡ä»¶</span><br><span class="line">    ssl_dhparam /etc/ssl/certs/dhparam.pem;</span><br><span class="line"></span><br><span class="line">    location ~ /.well-known &#123;</span><br><span class="line">        allow all;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    root /your/project/path;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files $uri $uri/ =404;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è§£é‡Šä¸€ä¸‹å…¶ä¸­å‡ é¡¹é…ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssl_stapling on;</span><br></pre></td></tr></table></figure>

<p>å¼€å¯ OCSP Staplingï¼Œä½¿æœåŠ¡ç«¯ä¸»åŠ¨è·å– OCSP æŸ¥è¯¢ç»“æœå¹¶éšç€è¯ä¹¦ä¸€èµ·å‘é€ç»™å®¢æˆ·ç«¯ï¼Œä»è€Œè®©å®¢æˆ·ç«¯è·³è¿‡è‡ªå·±å»éªŒè¯çš„è¿‡ç¨‹ï¼Œæé«˜ TLS æ¡æ‰‹æ•ˆç‡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">add_header Strict-Transport-Security &quot;max-age=63072000; includeSubdomains&quot;;</span><br></pre></td></tr></table></figure>

<p>å¯ç”¨ HSTS ç­–ç•¥ï¼Œå¼ºåˆ¶æµè§ˆå™¨ä½¿ç”¨ HTTPS è¿æ¥ï¼Œmax-ageè®¾ç½®å•ä½æ—¶é—´å†…å¼·åˆ¶ä½¿ç”¨ HTTPS è¿æ¥ï¼›includeSubDomains å¯é€‰ï¼Œè®¾ç½®æ‰€æœ‰å­åŸŸåŒæ—¶ç”Ÿæ•ˆã€‚æµè§ˆå™¨åœ¨è·å–è¯¥å“åº”å¤´åï¼Œåœ¨ max-age çš„æ—¶é—´å†…ï¼Œå¦‚æœé‡åˆ° HTTP è¿æ¥ï¼Œå°±ä¼šé€šè¿‡ 307 è·³è½¬å¼·åˆ¶ä½¿ç”¨ HTTPS è¿›è¡Œè¿æ¥</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">add_header X-Frame-Options DENY;</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ  X-Frame-Options å“åº”å¤´ï¼Œå¯ä»¥ç¦æ­¢ç½‘ç«™è¢«åµŒå…¥åˆ° iframe ä¸­ï¼Œå‡å°‘<a href="https://blogs.msdn.microsoft.com/ie/2009/01/27/ie8-security-part-vii-clickjacking-defenses/" target="_blank" rel="noopener">ç‚¹å‡»åŠ«æŒ (clickjacking)æ”»å‡»</a>ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">add_header X-Content-Type-Options nosniff;</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ  X-Content-Type-Options å“åº”å¤´ï¼Œé˜²æ­¢ <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types#MIME_sniffing" target="_blank" rel="noopener">MIME ç±»å‹å—…æ¢æ”»å‡»</a></p>
<p>è§£é‡Šå®Œæ¯•ã€‚ç»§ç»­ï¼Œæ¥æµ‹è¯• nginx.conf æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nginx -t</span><br></pre></td></tr></table></figure>

<p>é‡å¯ Nginx</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>

<h1 id="é‡å®šå‘-HTTP-åˆ°-HTTPS"><a href="#é‡å®šå‘-HTTP-åˆ°-HTTPS" class="headerlink" title="é‡å®šå‘ HTTP åˆ° HTTPS"></a>é‡å®šå‘ HTTP åˆ° HTTPS</h1><p>ä¿®æ”¹åŸæ¥ HTTP ç½‘ç«™çš„ Nginx é…ç½®ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name example.com www.example.com;</span><br><span class="line">    access_log /var/log/example/access.log;</span><br><span class="line">    error_log /var/log/example/error.log;</span><br><span class="line">    # 301 æ°¸ä¹…é‡å®šå‘</span><br><span class="line">    return 301 https://$host$request_uri;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root /your/project/path;</span><br><span class="line">        index index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶å†è®¿é—®ç½‘ç«™ï¼Œæµè§ˆå™¨åœ°å€æ å°±ä¼šå‡ºç°ä¸€æŠŠå°é”ã€‚<br><img src="https://mares.oss-cn-qingdao.aliyuncs.com/blog/https-upgrade/2.png" alt="https.png"></p>
<p>ä¸€æ—¦å‡çº§ HTTPSï¼Œç½‘ç«™å†…çš„æ‰€æœ‰èµ„æºæ–‡ä»¶å’Œè¯·æ±‚çš„åè®®ä¹Ÿå¿…é¡»ä¸º HTTPSï¼Œä½ éœ€è¦åœ¨å‰ç«¯ä»£ç é‡Œä¿®æ”¹ä¸€ä¸‹ã€‚</p>
<p>æœ€åå¯ä»¥ä½¿ç”¨ <a href="https://www.ssllabs.com/ssltest/analyze.html" target="_blank" rel="noopener">ssllabs</a> æµ‹è¯•ä¸€ä¸‹ç½‘ç«™çš„å®‰å…¨æ€§ï¼Œæˆ‘çš„ç½‘ç«™å¾—äº† A+ğŸ˜</p>
<hr>
<p>å‚è€ƒé“¾æ¥ï¼š</p>
<ol>
<li><a href="https://aotu.io/notes/2016/08/16/nginx-https/" target="_blank" rel="noopener">Nginx é…ç½® HTTPS æœåŠ¡å™¨</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-centos-7" target="_blank" rel="noopener">How To Secure Nginx with Letâ€™s Encrypt on CentOS 7</a></li>
</ol>

    </div>

</div>
                <div class="footer">
    <span>Copyright Â© 2022 Lynx</span>
    <span>Theme Designed By <a target="_blank" href="https://zheli.design/one-paper">é€™Li</a></span>
</div>

<link rel="stylesheet" href="/css/a11y-dark.min.css">
<script src="/js/highlight.min.js"></script>
<script src="/js/highlightjs-line-numbers.js"></script>

<script>
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
</script>

            </div>
        </div>
        <script>
            var _hmt = _hmt || [];
            (function() {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?be4f38e2c43dbecf025baf47c07262a6";
                var s = document.getElementsByTagName("script")[0]; 
                s.parentNode.insertBefore(hm, s);
            })();
        </script>
    </body>
</html>