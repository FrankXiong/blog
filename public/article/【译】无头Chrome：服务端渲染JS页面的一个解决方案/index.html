<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <link rel="alternate icon" type="image/jpg" href="//mares.oss-cn-qingdao.aliyuncs.com/avatar.jpg">
    <title>Lynx | å°ç†Šå†™å­—çš„åœ°æ–¹</title>
    <meta name="description" content="ç†Šè´¤ä»çš„ä¸ªäººåšå®¢">
    <meta name="keywords" content="Node.js,Vue,React,JavaScript,Git,è½¯ä»¶å¼€å‘,webå‰ç«¯,æŠ€æœ¯,ç¨‹åºå‘˜,æ€è€ƒ">
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/markdown.css">
    <link rel="stylesheet" href="/css/fonts.css">
<link rel="alternate" href="/atom.xml" title="Lynx" type="application/atom+xml">
</head>
    <body>
        <div class="paper">
            <div class="paper-main">
                
                    <div class="post-header">
    <a class="logo" href="/">Lynx</a>
    <a class="go-home" href="/">
        <svg width="8" height="14" viewBox="0 0 8 14">
            <path d="M7 1L1 7l6 6" stroke="#000" stroke-width="2" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </a>
</div>
                
                <div class="post-main">

    
        <div class="post-main-title">
            ã€è¯‘ã€‘æ— å¤´ Chromeï¼šæœåŠ¡ç«¯æ¸²æŸ“ JS é¡µé¢çš„ä¸€ä¸ªè§£å†³æ–¹æ¡ˆ
        </div>
        <div class="post-meta">
            2018-09-17
        </div>
    

    <div class="post-md">
        <h3 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h3><blockquote>
<p><a href="https://developers.google.com/web/updates/2017/04/headless-chrome" target="_blank" rel="noopener">æ— å¤´ Chrome</a> æ˜¯ä¸€ä¸ªå°†åŠ¨æ€ JS é¡µé¢è½¬æˆé™æ€ HTML é¡µé¢çš„å³æ’å³ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚å°†å…¶è¿è¡Œäº web æœåŠ¡å™¨ä¹‹ä¸Šï¼Œä½ å¯ä»¥<strong>é¢„æ¸²æŸ“ä»»ä½•ç°ä»£ JS ç‰¹æ€§</strong>ï¼Œä»è€Œæé€Ÿå†…å®¹åŠ è½½ï¼Œå¹¶ä¸”æ˜¯<strong>å¯è¢«æœç´¢å¼•æ“ç´¢å¼•çš„</strong>ã€‚</p>
</blockquote>
<p>æœ¬ç¯‡æ–‡ç« ä»‹ç»çš„æŠ€æœ¯ï¼Œæ—¨åœ¨æ•™å¤§å®¶å¦‚ä½•ä½¿ç”¨ <a href="https://developers.google.com/web/tools/puppeteer/" target="_blank" rel="noopener">Puppeteer</a> çš„ APIï¼Œç»™ä¸€ä¸ª Express æœåŠ¡å™¨æ·»åŠ æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰èƒ½åŠ›ã€‚æœ€æ£’çš„åœ°æ–¹æ˜¯ï¼Œ<strong>åº”ç”¨æœ¬èº«å‡ ä¹ä¸éœ€è¦ä¿®æ”¹ä»»ä½•ä»£ç </strong>ã€‚æ— å¤´ Chrome åšäº†æ‰€æœ‰çš„é‡æ´»ã€‚ä¸‰ä¸¤è¡Œä»£ç ï¼ŒSSR é¡µé¢å¸¦å›å®¶ã€‚</p>
<p>å¤§é¤ä¹‹å‰å…ˆæ¥ç‚¹ç”œç‚¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import puppeteer from &apos;puppeteer&apos;;</span><br><span class="line"></span><br><span class="line">async function ssr(url) &#123;</span><br><span class="line">  const browser = await puppeteer.launch(&#123;headless: true&#125;);</span><br><span class="line">  const page = await browser.newPage();</span><br><span class="line">  await page.goto(url, &#123;waitUntil: &apos;networkidle0&apos;&#125;);</span><br><span class="line">  const html = await page.content(); // serialized HTML of page DOM.</span><br><span class="line">  await browser.close();</span><br><span class="line">  return html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„ï¼š</strong> æˆ‘ä¼šåœ¨æ–‡ç« ä¸­ä½¿ç”¨ ES æ¨¡å—ï¼ˆ<code>import</code>ï¼‰ï¼Œè¿™è¦æ±‚ Node 8.5.0+ï¼Œå¹¶åœ¨è¿è¡Œæ—¶åŠ ä¸Š <code>--experimental-modules</code> æ ‡å¿—ã€‚è§‰å¾—éº»çƒ¦çš„è¯å¯ä»¥è‡ªè¡Œä½¿ç”¨ <code>require()</code> è¯­å¥ã€‚å…³äº Node ä¸Šçš„ ES æ¨¡å—æ”¯æŒå¯ä»¥è¯»è¯»<a href="https://nodejs.org/api/esm.html" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ã€‚</p>
<br>
## å¯¼è®º
----------------------------

<p>å¦‚æœæˆ‘å¯¹ <a href="https://en.wikipedia.org/wiki/Search_engine_optimization" target="_blank" rel="noopener">SEO</a> ç†è§£æ²¡æœ‰åå·®çš„è¯ï¼Œä½ è¯»åˆ°è¿™ç¯‡æ–‡ç« å¯èƒ½å› ä¸ºä¸‹é¢ä¸¤ä¸ªåŸå› ä¹‹ä¸€ã€‚é¦–å…ˆï¼Œä½ å·²ç»æ­å»ºäº†ä¸€ä¸ª web åº”ç”¨ï¼Œå¹¶ä¸”å®ƒæ²¡æœ‰è¢«æœç´¢å¼•æ“ç´¢å¼•ï¼ä½ çš„åº”ç”¨å¯èƒ½æ˜¯ SPAï¼Œ<a href="https://developers.google.com/web/progressive-web-apps/" target="_blank" rel="noopener">PWA</a>ï¼Œä½¿ç”¨äº† vanilla JSï¼Œæˆ–è€…ä½¿ç”¨äº†å…¶ä»–æ›´å¤æ‚çš„æ¡†æ¶æˆ–ç±»åº“ã€‚è€å®è¯´ï¼Œä½ ä½¿ç”¨ä½•ç§æŠ€æœ¯å¹¶ä¸é‡è¦ã€‚é‡è¦çš„æ˜¯ï¼Œä½ èŠ±è´¹äº†å¤§é‡æ—¶é—´æ­å»ºå‡ºä¼˜ç§€çš„ web é¡µé¢ï¼Œç„¶è€Œç”¨æˆ·å´æœä¸åˆ°å®ƒã€‚ä½ è¯»è¿™ç¯‡æ–‡ç« çš„å¦ä¸€ä¸ªç†ç”±å¯èƒ½æ˜¯å› ä¸ºï¼Œç½‘ä¸Šä¸€äº›æ–‡ç« è¯´äº†æœåŠ¡ç«¯æ¸²æŸ“å¯ä»¥æå‡æ€§èƒ½ã€‚ä½ å¸Œæœ›å¿«é€Ÿå‡å°‘<a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/javascript-startup-optimization/" target="_blank" rel="noopener"> JavaScript å¯åŠ¨æ—¶é—´</a>ï¼Œæå‡<a href="https://developers.google.com/web/tools/lighthouse/audits/first-meaningful-paint" target="_blank" rel="noopener">é¦–æ¬¡æœ‰æ•ˆç»˜åˆ¶</a>é€Ÿåº¦ã€‚</p>
<p>ä¸€äº›æ¡†æ¶ï¼Œæ¯”å¦‚ Preact ä½¿ç”¨äº†<a href="https://github.com/developit/preact-render-to-string" target="_blank" rel="noopener">å·¥å…·</a>æ¥å®ç°æœåŠ¡ç«¯æ¸²æŸ“ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ¡†æ¶å…·å¤‡é¢„æ¸²æŸ“çš„è§£å†³æ–¹æ¡ˆï¼Œè¯·ç»§ç»­ä½¿ç”¨ã€‚æ²¡æœ‰ä»»ä½•ç†ç”±å¼•å…¥å¦ä¸€ä¸ªå·¥å…·ï¼ˆæ— å¤´ Chrome &#x2F; Puppeteerï¼‰ã€‚</p>
<h3 id="çˆ¬å–ç°ä»£ç½‘ç«™"><a href="#çˆ¬å–ç°ä»£ç½‘ç«™" class="headerlink" title="çˆ¬å–ç°ä»£ç½‘ç«™"></a>çˆ¬å–ç°ä»£ç½‘ç«™</h3><p>æœç´¢å¼•æ“çˆ¬è™«ï¼Œç¤¾äº¤å¹³å°ï¼Œ<a href="https://en.wikipedia.org/wiki/Lynx_(web_browser)" target="_blank" rel="noopener">ç”šè‡³æµè§ˆå™¨</a>è‡ªè¯ç”Ÿè‡³ä»Šå°±å”¯ä¸€ä¾èµ–äºé™æ€ HTML æ ‡è®°ï¼Œæ¥ç´¢å¼• web é¡µé¢å’Œè¡¨å±‚å†…å®¹ã€‚ç°ä»£ web é¡µé¢å·²ç»æ¼”å˜çš„å¤§ä¸ºä¸åŒã€‚åŸºäº JavaScript çš„åº”ç”¨ï¼Œåœ¨å¾ˆå¤šæ—¶å€™ï¼Œéœ€è¦ä¿æŒç½‘ç«™å†…å®¹æ˜¯å¯¹äºçˆ¬å–å·¥å…·æ˜¯å¯è§çš„ã€‚</p>
<p>ä¸€äº›çˆ¬è™«ï¼Œæ¯”å¦‚ Google æœç´¢ï¼Œå·²ç»å˜å¾—æ›´æ™ºèƒ½äº†ï¼Google çš„çˆ¬è™«ä½¿ç”¨ Chrome 41 <a href="https://developers.google.com/search/docs/guides/rendering" target="_blank" rel="noopener">æ‰§è¡Œ JavaScript</a>ï¼Œå¹¶æ¸²æŸ“å‡ºæœ€ç»ˆçš„é¡µé¢ã€‚ä½†æ˜¯è¿™ä¸ªæ–¹æ¡ˆæ‰åˆšå‡ºæ¥ï¼Œè¿˜ä¸å®Œç¾ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä½¿ç”¨äº†æ–°ç‰¹æ€§çš„é¡µé¢ï¼Œæ¯”å¦‚ ES6 Classï¼Œ<a href="https://www.chromestatus.com/feature/5365692190687232" target="_blank" rel="noopener">æ¨¡å—</a>ï¼Œç®­å¤´å‡½æ•°ç­‰ï¼Œå°†ä¼šåœ¨è¿™ä¸ªæ¯”è¾ƒè€çš„æµè§ˆå™¨ä¸ŠæŠ¥é”™ï¼Œä½¿å¾—é¡µé¢ä¸èƒ½æ­£ç¡®æ¸²æŸ“ã€‚è‡³äºå…¶ä»–æœç´¢å¼•æ“ï¼Œé¬¼çŸ¥é“å®ƒä»¬åœ¨å¹²å˜›ï¼ï¼ŸÂ¯_(ãƒ„)_&#x2F;Â¯</p>
<h2 id="ä½¿ç”¨æ— å¤´-Chrome-é¢„æ¸²æŸ“é¡µé¢"><a href="#ä½¿ç”¨æ— å¤´-Chrome-é¢„æ¸²æŸ“é¡µé¢" class="headerlink" title="ä½¿ç”¨æ— å¤´ Chrome é¢„æ¸²æŸ“é¡µé¢"></a>ä½¿ç”¨æ— å¤´ Chrome é¢„æ¸²æŸ“é¡µé¢</h2><hr>
<p>æ‰€æœ‰çš„çˆ¬è™«ç¨‹åºéƒ½èƒ½å¤Ÿç†è§£ HTMLã€‚æˆ‘ä»¬è¦â€œè§£å†³â€ç´¢å¼•é—®é¢˜çš„è¯éœ€è¦ä¸€ä¸ªå·¥å…·ï¼Œå®ƒæ¥æ‰§è¡Œ JS ç”Ÿæˆ HTMLã€‚æˆ‘ä¸ä¼šå‘Šè¯‰ä½ ç°åœ¨å·²ç»æœ‰è¿™æ ·ä¸€ä¸ªå·¥å…·äº†ï¼</p>
<ol>
<li>è¯¥å·¥å…·å¯ä»¥è¿è¡Œæ‰€æœ‰ç±»å‹çš„ç°ä»£ JavaScriptï¼Œå¹¶åå‡ºé™æ€ HTMLã€‚</li>
<li>å‡ºç°æ–°ç‰¹æ€§æ—¶ï¼Œè¯¥å·¥å…·å¯ä»¥ä¿æŒæ›´æ–°</li>
<li>å·²æœ‰åº”ç”¨ä¸Šåªéœ€å°‘é‡ä»£ç å°±å¯ä»¥è¿è¡Œè¿™ä¸ªå·¥å…·</li>
</ol>
<p>å¬èµ·æ¥å¾ˆä¸é”™å§ï¼Ÿ<strong>è¿™ä¸ªå·¥å…·å°±æ˜¯æµè§ˆå™¨</strong>ï¼</p>
<p>æ— å¤´ Chrome ä¸åœ¨ä¹ä½ ä½¿ç”¨ä»€ä¹ˆåº“ã€æ¡†æ¶æˆ–è€…å·¥å…·ã€‚å®ƒå°† JavaScript ä½œä¸ºæ—©é¤ï¼Œåœ¨åˆé¥­å‰åå‡ºé™æ€ HTMLã€‚å¯èƒ½ä¼šæ›´å¿«ä¸€ç‚¹ :) -Eric</p>
<p>å¦‚æœä½ ç”¨çš„ Nodeï¼ŒPuppeteer å®¹æ˜“ä¸Šæ‰‹ã€‚å®ƒçš„ API æä¾›äº†é¢„æ¸²æŸ“å®¢æˆ·ç«¯åº”ç”¨çš„èƒ½åŠ›ã€‚ä¸‹é¢ç”¨ä¸ªä¾‹å­æ¼”ç¤ºä¸‹ã€‚</p>
<h3 id="1-JS-åº”ç”¨ç¤ºä¾‹"><a href="#1-JS-åº”ç”¨ç¤ºä¾‹" class="headerlink" title="1. JS åº”ç”¨ç¤ºä¾‹"></a>1. JS åº”ç”¨ç¤ºä¾‹</h3><p>æˆ‘ä»¬ä»¥ä¸€ä¸ª JavaScript ç”Ÿæˆ HTML çš„åŠ¨æ€é¡µé¢ä¸ºä¾‹ï¼š</p>
<p><strong>public&#x2F;index.html</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div id=&quot;container&quot;&gt;</span><br><span class="line">    &lt;!-- Populated by the JS below. --&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">function renderPosts(posts, container) &#123;</span><br><span class="line">  const html = posts.reduce((html, post) =&gt; &#123;</span><br><span class="line">    return `$&#123;html&#125;</span><br><span class="line">      &lt;li class=&quot;post&quot;&gt;</span><br><span class="line">        &lt;h2&gt;$&#123;post.title&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;div class=&quot;summary&quot;&gt;$&#123;post.summary&#125;&lt;/div&gt;</span><br><span class="line">        &lt;p&gt;$&#123;post.content&#125;&lt;/p&gt;</span><br><span class="line">      &lt;/li&gt;`;</span><br><span class="line">  &#125;, &apos;&apos;);</span><br><span class="line"></span><br><span class="line">  // CAREFUL: assumes html is sanitized.</span><br><span class="line">  container.innerHTML = `&lt;ul id=&quot;posts&quot;&gt;$&#123;html&#125;&lt;/ul&gt;`;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(async() =&gt; &#123;</span><br><span class="line">  const container = document.querySelector(&apos;#container&apos;);</span><br><span class="line">  const posts = await fetch(&apos;/posts&apos;).then(resp =&gt; resp.json());</span><br><span class="line">  renderPosts(posts, container);</span><br><span class="line">&#125;)();</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-æœåŠ¡ç«¯æ¸²æŸ“å‡½æ•°"><a href="#2-æœåŠ¡ç«¯æ¸²æŸ“å‡½æ•°" class="headerlink" title="2. æœåŠ¡ç«¯æ¸²æŸ“å‡½æ•°"></a>2. æœåŠ¡ç«¯æ¸²æŸ“å‡½æ•°</h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ä¹‹å‰æåˆ°çš„ <code>ssr()</code> å‡½æ•°ï¼Œå¹¶å……å®å®ƒçš„å†…å®¹ã€‚</p>
<p><strong>ssr.mjs</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import puppeteer from &apos;puppeteer&apos;;</span><br><span class="line"></span><br><span class="line">// In-memory cache of rendered pages. Note: this will be cleared whenever the</span><br><span class="line">// server process stops. If you need true persistence, use something like</span><br><span class="line">// Google Cloud Storage (https://firebase.google.com/docs/storage/web/start).</span><br><span class="line">const RENDER_CACHE = new Map();</span><br><span class="line"></span><br><span class="line">async function ssr(url) &#123;</span><br><span class="line">  if (RENDER_CACHE.has(url)) &#123;</span><br><span class="line">    return &#123;html: RENDER_CACHE.get(url), ttRenderMs: 0&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const start = Date.now();</span><br><span class="line"></span><br><span class="line">  const browser = await puppeteer.launch();</span><br><span class="line">  const page = await browser.newPage();</span><br><span class="line">  try &#123;</span><br><span class="line">    // networkidle0 waits for the network to be idle (no requests for 500ms).</span><br><span class="line">    // The page&apos;s JS has likely produced markup by this point, but wait longer</span><br><span class="line">    // if your site lazy loads, etc.</span><br><span class="line">    await page.goto(url, &#123;waitUntil: &apos;networkidle0&apos;&#125;);</span><br><span class="line">    await page.waitForSelector(&apos;#posts&apos;); // ensure #posts exists in the DOM.</span><br><span class="line">  &#125; catch (err) &#123;</span><br><span class="line">    console.error(err);</span><br><span class="line">    throw new Error(&apos;page.goto/waitForSelector timed out.&apos;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const html = await page.content(); // serialized HTML of page DOM.</span><br><span class="line">  await browser.close();</span><br><span class="line"></span><br><span class="line">  const ttRenderMs = Date.now() - start;</span><br><span class="line">  console.info(`Headless rendered page in: $&#123;ttRenderMs&#125;ms`);</span><br><span class="line"></span><br><span class="line">  RENDER_CACHE.set(url, html); // cache rendered page.</span><br><span class="line"></span><br><span class="line">  return &#123;html, ttRenderMs&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export &#123;ssr as default&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦çš„å˜åŒ–ï¼š</p>
<ol>
<li>æ·»åŠ äº†ç¼“å­˜ã€‚ç¼“å­˜å·²æ¸²æŸ“çš„ HTML å¯¹äºåŠ é€Ÿå“åº”æ—¶é—´å±…åŠŸè‡³ä¼Ÿã€‚å½“é¡µé¢å†æ¬¡æœ‰è¯·æ±‚è¿‡æ¥ï¼Œé¿å…äº†æ— å¤´ Chrome çš„é‡å¤æ‰§è¡Œã€‚æˆ‘éšåä¼šè®¨è®ºå…¶ä»–çš„<a href="#optimizations">ä¼˜åŒ–</a> ã€‚</li>
<li>æ·»åŠ åŠ è½½é¡µé¢è¶…æ—¶æ—¶çš„åŸºæœ¬é”™è¯¯å¤„ç†ã€‚</li>
<li>æ·»åŠ äº† <code>page.waitForSelector(&#39;#posts&#39;)</code> è¿™è¡Œä»£ç ã€‚ç¡®ä¿åœ¨ä¸¢å¼ƒè¿™ä¸ªåºåˆ—åŒ–é¡µé¢ä¹‹å‰ï¼Œposts èŠ‚ç‚¹å­˜åœ¨äº DOM ä¹‹ä¸­ã€‚</li>
<li>è®°å½•æ— å¤´æµè§ˆå™¨æ¸²æŸ“é¡µé¢æ‰€ç”¨æ—¶é—´ã€‚</li>
<li>ä»£ç éƒ½è¢«å°è£…è¿›åä¸º <code>ssr.mjs</code> çš„æ¨¡å—ä¸­ã€‚</li>
</ol>
<h3 id="3-web-æœåŠ¡å™¨ç¤ºä¾‹"><a href="#3-web-æœåŠ¡å™¨ç¤ºä¾‹" class="headerlink" title="3. web æœåŠ¡å™¨ç¤ºä¾‹"></a>3. web æœåŠ¡å™¨ç¤ºä¾‹</h3><p>æœ€åï¼Œä¸€ä¸ªå°çš„ express æœåŠ¡å™¨å®Œæˆäº†æ‰€æœ‰çš„å·¥ä½œã€‚å®ƒé¢„æ¸²æŸ“ URL <code>http://localhost/index.html</code>ï¼ˆä¸»é¡µï¼‰ï¼Œå¹¶åœ¨å“åº”ä¸­è¿”å›æ¸²æŸ“ç»“æœã€‚ç”±äºå“åº”ä¸­åŒ…å«äº†é™æ€ HTMLï¼Œ å½“ç”¨æˆ·è®¿é—®é¡µé¢ï¼Œposts èŠ‚ç‚¹ä¼šç«‹åˆ»å‘ˆç°ã€‚</p>
<p><strong>server.mjs</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import express from &apos;express&apos;;</span><br><span class="line">import ssr from &apos;./ssr.mjs&apos;;</span><br><span class="line"></span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">app.get(&apos;/&apos;, async (req, res, next) =&gt; &#123;</span><br><span class="line">  const &#123;html, ttRenderMs&#125; = await ssr(`$&#123;req.protocol&#125;://$&#123;req.get(&apos;host&apos;)&#125;/index.html`);</span><br><span class="line">  // Add Server-Timing! See https://w3c.github.io/server-timing/.</span><br><span class="line">  res.set(&apos;Server-Timing&apos;, `Prerender;dur=$&#123;ttRenderMs&#125;;desc=&quot;Headless render time (ms)&quot;`);</span><br><span class="line">  return res.status(200).send(html); // Serve prerendered page as response.</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(8080, () =&gt; console.log(&apos;Server started. Press Ctrl+C to quit&apos;));</span><br></pre></td></tr></table></figure>

<p>è¦è¿è¡Œè¿™ä¸ªä¾‹å­ï¼Œéœ€å®‰è£…ä¾èµ– (<code>npm i --save puppeteer express</code>)ï¼Œç„¶åä½¿ç”¨ Node 8.5.0+ å¹¶å¸¦æœ‰ <code>--experimental-modules</code> æ ‡å¿—æ¥è¿è¡ŒæœåŠ¡å™¨ã€‚</p>
<p>è¿™æ˜¯ä¸€ä¸ªè¯¥æœåŠ¡å™¨è¿”å›çš„å“åº”ç¤ºä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div id=&quot;container&quot;&gt;</span><br><span class="line">    &lt;ul id=&quot;posts&quot;&gt;</span><br><span class="line">      &lt;li class=&quot;post&quot;&gt;</span><br><span class="line">        &lt;h2&gt;Title 1&lt;/h2&gt;</span><br><span class="line">        &lt;div class=&quot;summary&quot;&gt;Summary 1&lt;/div&gt;</span><br><span class="line">        &lt;p&gt;post content 1&lt;/p&gt;</span><br><span class="line">      &lt;/li&gt;</span><br><span class="line">      &lt;li class=&quot;post&quot;&gt;</span><br><span class="line">        &lt;h2&gt;Title 2&lt;/h2&gt;</span><br><span class="line">        &lt;div class=&quot;summary&quot;&gt;Summary 2&lt;/div&gt;</span><br><span class="line">        &lt;p&gt;post content 2&lt;/p&gt;</span><br><span class="line">      &lt;/li&gt;</span><br><span class="line">      ...</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h4 id="Server-Timing-API-çš„ä¸€ä¸ªæœ€ä½³ç”¨ä¾‹"><a href="#Server-Timing-API-çš„ä¸€ä¸ªæœ€ä½³ç”¨ä¾‹" class="headerlink" title="Server-Timing API çš„ä¸€ä¸ªæœ€ä½³ç”¨ä¾‹"></a>Server-Timing API çš„ä¸€ä¸ªæœ€ä½³ç”¨ä¾‹</h4><p><a href="https://w3c.github.io/server-timing/" target="_blank" rel="noopener">Server-Timing</a> API æ”¯æŒå°†æœåŠ¡å™¨æ€§èƒ½æŒ‡æ ‡ï¼ˆæ¯”å¦‚è¯·æ±‚&#x2F;å“åº”æ—¶é—´ï¼Œæ•°æ®åº“æŸ¥è¯¢ï¼‰è¿”å›ç»™æµè§ˆå™¨ã€‚å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨è¿™äº›ä¿¡æ¯æ¥è¿½è¸ª web åº”ç”¨çš„æ‰€æœ‰æ€§èƒ½æ•°æ®ã€‚</p>
<p>Server-Timing çš„ä¸€ä¸ªæœ€ä½³ç”¨ä¾‹æ˜¯ä¸ŠæŠ¥æ— å¤´ Chrome é¢„æ¸²æŸ“é¡µé¢çš„æ—¶é—´ï¼åªéœ€åœ¨å“åº”ä¸Šæ·»åŠ  <code>Server-Timing</code> å¤´ï¼Œå°±å¯ä»¥å®ç°è¿™ä¸€ç‚¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">res.set(&apos;Server-Timing&apos;,  `Prerender;dur=1000;desc=&quot;Headless render time (ms)&quot;`);</span><br></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯ä¸Šï¼Œ<a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance_Timeline" target="_blank" rel="noopener">Performance Timeline API</a> å’Œ <a href="https://developer.mozilla.org/en-US/docs/Web/API/PerformanceObserver" target="_blank" rel="noopener">PerformanceObserver</a> å¯ä»¥è·å–è¿™äº›æŒ‡æ ‡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  const entry = performance.getEntriesByType(&apos;navigation&apos;).find(</span><br><span class="line">    e =&gt; e.name === location.href);</span><br><span class="line">console.log(entry.serverTiming[0].toJSON());</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;Prerender&quot;,</span><br><span class="line">  &quot;duration&quot;: 3808,</span><br><span class="line">  &quot;description&quot;: &quot;Headless render time (ms)&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ€§èƒ½ç»“æœ"><a href="#æ€§èƒ½ç»“æœ" class="headerlink" title="æ€§èƒ½ç»“æœ"></a>æ€§èƒ½ç»“æœ</h3><p><strong>æ³¨æ„ï¼š</strong> è¿™äº›æ•°æ®ä½“ç°äº†æˆ‘éšåè®¨è®ºçš„å¤§å¤šæ•°æ€§èƒ½<a href="#optimizations">ä¼˜åŒ–</a>ã€‚</p>
<p>æ€§èƒ½æ•°æ®æ€ä¹ˆæ ·ï¼Ÿåœ¨æˆ‘çš„ä¸€ä¸ª<a href="https://devwebfeed.appspot.com/ssr" target="_blank" rel="noopener">åº”ç”¨</a>(<a href="https://github.com/ebidel/devwebfeed/blob/master/server.mjs" target="_blank" rel="noopener">ä»£ç </a>)ä¸Šï¼Œæ— å¤´ Chrome æ¸²æŸ“é¡µé¢å¤§çº¦éœ€è¦ 1sã€‚é¡µé¢è¢«ç¼“å­˜åï¼Œ <strong>3G ä½ç½‘é€Ÿæ¨¡æ‹Ÿ</strong>ä¸‹ï¼Œ<a href="https://developers.google.com/web/fundamentals/performance/user-centric-performance-metrics" target="_blank" rel="noopener">FCP</a> è¦æ¯”å®¢æˆ·ç«¯æ¸²æŸ“ç‰ˆæœ¬çš„<strong>å¿« 8.37s</strong>ã€‚</p>
<table>
<thead>
<tr>
<th>&amp;nbsp;</th>
<th><strong>é¦–æ¬¡ç»˜åˆ¶ (FP)</strong></th>
<th><strong>é¦–æ¬¡å†…å®¹ç»˜åˆ¶ (FCP)</strong></th>
</tr>
</thead>
<tbody><tr>
<td>å®¢æˆ·ç«¯æ¸²æŸ“</td>
<td>4s</td>
<td>11s</td>
</tr>
<tr>
<td>æœåŠ¡ç«¯æ¸²æŸ“</td>
<td>2.3s</td>
<td>~2.3s</td>
</tr>
</tbody></table>
<p>è¿™äº›ç»“æœå¾ˆæœ‰ç”¨ã€‚å› ä¸ºæœåŠ¡ç«¯æ¸²æŸ“é¡µé¢<strong>ä¸å†ä¾èµ–äº JavaScript çš„åŠ è½½</strong>ï¼Œç”¨æˆ·çœ‹åˆ°æœ‰æ„ä¹‰çš„å†…å®¹æ¯”ä»¥å‰å¿«å¾—å¤šã€‚</p>
<br>

<h2 id="Preventing-re-hydration"><a href="#Preventing-re-hydration" class="headerlink" title="Preventing re-hydration"></a>Preventing re-hydration</h2><hr>
<p>è¿˜è®°å¾—æˆ‘è¯´â€œæˆ‘ä»¬æ— éœ€åœ¨å®¢æˆ·ç«¯åº”ç”¨ä¸Šæ”¹ä»»ä½•ä»£ç â€å—ï¼Ÿé‚£æ˜¯éª—ä½ ä»¬çš„ã€‚</p>
<p>Express åº”ç”¨æ¥æ”¶è¯·æ±‚ï¼Œä½¿ç”¨ Puppeteer å°†é¡µé¢åŠ è½½è¿›æ— å¤´æµè§ˆå™¨ï¼Œç„¶ååœ¨å“åº”ä¸­è¿”å›ç»“æœã€‚ä½†è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ã€‚</p>
<p>æµè§ˆå™¨åŠ è½½é¡µé¢æ—¶ï¼Œ<strong>æ— å¤´ Chrome ä¸­ç›¸åŒçš„ JS</strong> ä¼šåœ¨æœåŠ¡å™¨ä¸Š<strong>å†æ¬¡æ‰§è¡Œ</strong>ã€‚æœ‰ä¸¤å¤„éƒ½åœ¨ç”Ÿæˆ HTMLã€‚ </p>
<p>ä¸€èµ·æ¥ä¿®å¤è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬è¦å‘ŠçŸ¥é¡µé¢ï¼Œå®ƒçš„ HTML æ—©å°±åèŠ±æœ‰ä¸»äº†ã€‚æˆ‘æ‰¾åˆ°çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œåœ¨é¡µé¢åŠ è½½æ—¶åˆ¤æ–­ <code>&lt;ul id=&quot;posts&quot;&gt;</code> æ˜¯å¦å·²åœ¨ DOM ä¸­ï¼Œå¦‚æœåœ¨ï¼Œé¡µé¢å°±å·²ç»åœ¨æœåŠ¡ç«¯æ¸²æŸ“è¿‡äº†ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…é‡æ–°åˆ›å»º DOMã€‚</p>
<p><strong>public&#x2F;index.html</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div id=&quot;container&quot;&gt;</span><br><span class="line">    &lt;!-- Populated by JS (below) or by prerendering (server). Either way,</span><br><span class="line">         #container gets populated with the posts markup:</span><br><span class="line">      &lt;ul id=&quot;posts&quot;&gt;...&lt;/ul&gt;</span><br><span class="line">    --&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">...</span><br><span class="line">(async() =&gt; &#123;</span><br><span class="line">  const container = document.querySelector(&apos;#container&apos;);</span><br><span class="line"></span><br><span class="line">  // Posts markup is already in DOM if we&apos;re seeing a SSR&apos;d.</span><br><span class="line">  // Don&apos;t re-hydrate the posts here on the client.</span><br><span class="line">  const PRE_RENDERED = container.querySelector(&apos;#posts&apos;);</span><br><span class="line">  if (!PRE_RENDERED) &#123;</span><br><span class="line">    const posts = await fetch(&apos;/posts&apos;).then(resp =&gt; resp.json());</span><br><span class="line">    renderPosts(posts, container);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<br>

<h2 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h2><hr>
<p>é™¤äº†ç¼“å­˜æ¸²æŸ“ç»“æœä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›æœ‰è¶£çš„ä¼˜åŒ–æŠ€å·§ã€‚æœ‰çš„ä¼˜åŒ–å¯ä»¥å¿«é€Ÿè§æ•ˆï¼Œè€Œæœ‰çš„å¯èƒ½å¸¦æœ‰çŒœæµ‹æ€§çš„ã€‚</p>
<h3 id="ä¸­æ­¢ä¸å¿…è¦çš„è¯·æ±‚"><a href="#ä¸­æ­¢ä¸å¿…è¦çš„è¯·æ±‚" class="headerlink" title="ä¸­æ­¢ä¸å¿…è¦çš„è¯·æ±‚"></a>ä¸­æ­¢ä¸å¿…è¦çš„è¯·æ±‚</h3><p>ç°åœ¨ï¼Œæ•´ä¸ªé¡µé¢ï¼ˆä»¥åŠå®ƒè¯·æ±‚çš„æ‰€æœ‰èµ„æºï¼‰éƒ½æ— è„‘åœ°åŠ è½½è¿›æ— å¤´ Chromeã€‚ç„¶è€Œï¼Œæˆ‘ä»¬åªå…³æ³¨äºä¸¤ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>æ¸²æŸ“ HTML</li>
<li>ç”Ÿæˆ HTML çš„ JS</li>
</ol>
<p><strong>ä¸æ„é€  DOM çš„ç½‘ç»œè¯·æ±‚æ˜¯æµªè´¹çš„</strong>ã€‚ä¸€äº›èµ„æºï¼Œæ¯”å¦‚å›¾ç‰‡ã€å­—ä½“ã€æ ·å¼è¡¨å’Œåª’ä½“å†…å®¹ï¼Œä¸å‚ä¸é¡µé¢çš„ HTML æ„å»ºã€‚å®ƒä»¬è´Ÿè´£æ·»åŠ æ ·å¼ï¼Œè¡¥å……é¡µé¢çš„ç»“æ„ï¼Œä½†å¹¶ä¸æ˜¾å¼åœ°åˆ›å»ºé¡µé¢ã€‚æˆ‘ä»¬åº”è¯¥å‘Šè¯‰æµè§ˆå™¨å»å¿½ç•¥æ‰è¿™äº›èµ„æºï¼è¿™æ ·å¯ä»¥å‡å°‘æ— å¤´ Chrome çš„å·¥ä½œè´Ÿæ‹…ï¼Œä»è€Œ<strong>èŠ‚çœå¸¦å®½</strong>ï¼Œå¹¶ä¸”æ½œåœ¨åœ°<strong>åŠ é€Ÿäº†å¤§å‹é¡µé¢çš„é¢„æ¸²æŸ“æ—¶é—´</strong>ã€‚</p>
<p><a href="https://chromedevtools.github.io/devtools-protocol/" target="_blank" rel="noopener">Protocol å¼€å‘è€…å·¥å…·</a>æä¾›äº†ä¸€ä¸ªå¼ºå¤§çš„ç‰¹æ€§ï¼Œå«åš<a href="https://chromedevtools.github.io/devtools-protocol/tot/Network#event-requestIntercepted" target="_blank" rel="noopener">ç½‘ç»œæ‹¦æˆª</a>ã€‚å®ƒå¯ä»¥ç”¨äº<strong>åœ¨æµè§ˆå™¨å‘å‡ºä¹‹å‰ä¿®æ”¹è¯·æ±‚</strong>ã€‚Puppeteer ä¹Ÿæ”¯æŒç½‘ç»œæ‹¦æˆªï¼Œå®ƒæ˜¯é€šè¿‡æ‰“å¼€ <a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md#pagesetrequestinterceptionvalue" target="_blank" rel="noopener"><code>page.setRequestInterception(true)</code></a>ï¼Œç›‘å¬<a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md#event-request" target="_blank" rel="noopener">é¡µé¢çš„ <code>request</code> äº‹ä»¶</a>æ¥å®ç°çš„ã€‚è¿™æ ·æˆ‘ä»¬å¯ä»¥ä¸­æ­¢æŸäº›èµ„æºè¯·æ±‚ã€‚</p>
<p><strong>ssr.mjs</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">async function ssr(url) &#123;</span><br><span class="line">  ...</span><br><span class="line">  const page = await browser.newPage();</span><br><span class="line"></span><br><span class="line">  // 1. Intercept network requests.</span><br><span class="line">  await page.setRequestInterception(true);</span><br><span class="line"></span><br><span class="line">  page.on(&apos;request&apos;, req =&gt; &#123;</span><br><span class="line">    // 2. Ignore requests for resources that don&apos;t produce DOM</span><br><span class="line">    // (images, stylesheets, media).</span><br><span class="line">    const whitelist = [&apos;document&apos;, &apos;script&apos;, &apos;xhr&apos;, &apos;fetch&apos;];</span><br><span class="line">    if (!whitelist.includes(req.resourceType())) &#123;</span><br><span class="line">      return req.abort();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 3. Pass through all other requests.</span><br><span class="line">    req.continue();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  await page.goto(url, &#123;waitUntil: &apos;networkidle0&apos;&#125;);</span><br><span class="line">  const html = await page.content(); // serialized HTML of page DOM.</span><br><span class="line">  await browser.close();</span><br><span class="line"></span><br><span class="line">  return &#123;html&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„ï¼š</strong> å®‰å…¨èµ·è§ï¼Œæˆ‘ä½¿ç”¨äº†ä¸€ä¸ªç™½åå•ï¼Œå…è®¸æ‰€æœ‰å…¶ä»–ç±»å‹çš„è¯·æ±‚èƒ½å¤Ÿç»§ç»­æ­£å¸¸å‘å‡ºã€‚é¢„å…ˆé¿å…ä¸­æ­¢æ‰å…¶ä»–å¿…è¦çš„è¯·æ±‚ã€‚</p>
<h3 id="å†…è”å…³é”®èµ„æº"><a href="#å†…è”å…³é”®èµ„æº" class="headerlink" title="å†…è”å…³é”®èµ„æº"></a>å†…è”å…³é”®èµ„æº</h3><p>ä½¿ç”¨æ„å»ºå·¥å…·ï¼ˆæ¯”å¦‚ <code>gulp</code>ï¼‰ç¼–è¯‘åº”ç”¨ï¼Œå¹¶åœ¨æ„å»ºæ—¶å°†å…³é”® CSS&#x2F;JS å†…è”åˆ°é¡µé¢å†…ï¼Œæ˜¯ä¸€ç§å¾ˆå¸¸è§çš„åšæ³•ã€‚ç”±äºæµè§ˆå™¨åˆå§‹åŒ–é¡µé¢åŠ è½½æ—¶çš„è¯·æ±‚æ•°æ›´å°‘äº†ï¼Œè¿™æ ·ä¹Ÿå°±åŠ é€Ÿäº†é¦–æ¬¡æœ‰æ•ˆç»˜åˆ¶æ—¶é—´ã€‚</p>
<p>åˆ«ç”¨æ„å»ºå·¥å…·äº†ï¼Œ<strong>æµè§ˆå™¨å°±æ˜¯ä½ çš„æ„å»ºå·¥å…·</strong>ï¼æˆ‘ä»¬å¯ä»¥ç”¨ Puppeteer ç®¡ç†é¡µé¢ DOMï¼Œå†…è”æ ·å¼ï¼ŒJavaScriptï¼Œ æˆ–è€…å…¶ä»–ä»»ä½•ä½ æƒ³åœ¨é¢„æ¸²æŸ“ä¹‹å‰åŠ åˆ°é¡µé¢ä¸­çš„ä¸œè¥¿ã€‚</p>
<p>è¿™ä¸ªä¾‹å­æ¼”ç¤ºäº†å¦‚ä½•æ‹¦æˆªæœ¬åœ°æ ·å¼è¡¨çš„å“åº”ï¼Œå¹¶å°†è¿™äº›èµ„æºå†…è”è¿› <code>&lt;style&gt;</code> æ ‡ç­¾ä¸­ï¼š</p>
<p><strong>ssr.mjs</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import urlModule from &apos;url&apos;;</span><br><span class="line">const URL = urlModule.URL;</span><br><span class="line"></span><br><span class="line">async function ssr(url) &#123;</span><br><span class="line">  ...</span><br><span class="line">  const stylesheetContents = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  // 1. Stash the responses of local stylesheets.</span><br><span class="line">  page.on(&apos;response&apos;, async resp =&gt; &#123;</span><br><span class="line">    const responseUrl = resp.url();</span><br><span class="line">    const sameOrigin = new URL(responseUrl).origin === new URL(url).origin;</span><br><span class="line">    const isStylesheet = resp.request().resourceType() === &apos;stylesheet&apos;;</span><br><span class="line">    if (sameOrigin &amp;&amp; isStylesheet) &#123;</span><br><span class="line">      stylesheetContents[responseUrl] = await resp.text();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  // 2. Load page as normal, waiting for network requests to be idle.</span><br><span class="line">  await page.goto(url, &#123;waitUntil: &apos;networkidle0&apos;&#125;);</span><br><span class="line"></span><br><span class="line">  // 3. Inline the CSS.</span><br><span class="line">  // Replace stylesheets in the page with their equivalent &lt;style&gt;.</span><br><span class="line">  await page.$$eval(&apos;link[rel=&quot;stylesheet&quot;]&apos;, (links, content) =&gt; &#123;</span><br><span class="line">    links.forEach(link =&gt; &#123;</span><br><span class="line">      const cssText = content[link.href];</span><br><span class="line">      if (cssText) &#123;</span><br><span class="line">        const style = document.createElement(&apos;style&apos;);</span><br><span class="line">        style.textContent = cssText;</span><br><span class="line">        link.replaceWith(style);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, stylesheetContents);</span><br><span class="line"></span><br><span class="line">  // 4. Get updated serialized HTML of page.</span><br><span class="line">  const html = await page.content();</span><br><span class="line">  await browser.close();</span><br><span class="line"></span><br><span class="line">  return &#123;html&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç ï¼š</p>
<ol>
<li>ä½¿ç”¨ä¸€ä¸ª <a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md#event-response" target="_blank" rel="noopener"><code>page.on(&#39;response&#39;)</code></a> å¤„ç†å™¨æ¥ç›‘å¬ç½‘ç»œå“åº”ã€‚</li>
<li>å‚¨è—æœ¬åœ°æ ·å¼è¡¨çš„å“åº”ã€‚</li>
<li>æ‰¾åˆ° DOM ä¸­æ‰€æœ‰çš„ <code>&lt;link rel=&quot;stylesheet&quot;&gt;</code>ï¼Œå°†å®ƒä»¬æ›¿æ¢æˆä¸€ä¸ªç­‰ä»·çš„ <code>&lt;style&gt;</code>ã€‚å…·ä½“è§ <a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md#pageevalselector-pagefunction-args" target="_blank" rel="noopener"><code>page.$$eval</code></a> API æ–‡æ¡£ã€‚<code>style.textContent</code> è¢«è®¾ä¸ºæ ·å¼è¡¨çš„å“åº”å†…å®¹ã€‚</li>
</ol>
<h3 id="è‡ªåŠ¨å‹ç¼©èµ„æº"><a href="#è‡ªåŠ¨å‹ç¼©èµ„æº" class="headerlink" title="è‡ªåŠ¨å‹ç¼©èµ„æº"></a>è‡ªåŠ¨å‹ç¼©èµ„æº</h3><p>å¦ä¸€ä¸ªå¯ä»¥å€ŸåŠ©ç½‘ç»œæ‹¦æˆªç©çš„å°æŠŠæˆæ˜¯<strong>ä¿®æ”¹è¯·æ±‚çš„å“åº”å†…å®¹</strong>ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œä½ æƒ³è¦å‹ç¼© CSSï¼Œä½†ä¹Ÿå¸Œæœ›å¼€å‘é˜¶æ®µä¸è¦è¢«å‹ç¼©ï¼Œè¿™æ ·å¼€å‘æ—¶èƒ½æ–¹ä¾¿äº›ã€‚å‡è®¾ä½ å·²ç»ç”¨å¦ä¸€ä¸ªå·¥å…·æ¥é¢„å‹ç¼© <code>styles.css</code>ï¼Œå¯ä»¥ç”¨ <code>Request.respond()</code>ï¼Œå°† <code>styles.css</code> çš„å†…å®¹é‡å†™ä¸º <code>styles.min.css</code>ã€‚</p>
<p><strong>ssr.mjs</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import fs from &apos;fs&apos;;</span><br><span class="line"></span><br><span class="line">async function ssr(url) &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  // 1. Intercept network requests.</span><br><span class="line">  await page.setRequestInterception(true);</span><br><span class="line"></span><br><span class="line">  page.on(&apos;request&apos;, req =&gt; &#123;</span><br><span class="line">    // 2. If request is for styles.css, respond with the minified version.</span><br><span class="line">    if (req.url().endsWith(&apos;styles.css&apos;)) &#123;</span><br><span class="line">      return req.respond(&#123;</span><br><span class="line">        status: 200,</span><br><span class="line">        contentType: &apos;text/css&apos;,</span><br><span class="line">        body: fs.readFileSync(&apos;./public/styles.min.css&apos;, &apos;utf-8&apos;)</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    req.continue();</span><br><span class="line">  &#125;);</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  const html = await page.content();</span><br><span class="line">  await browser.close();</span><br><span class="line"></span><br><span class="line">  return &#123;html&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é‡ç”¨-Chrome-å®ä¾‹å®ç°äº¤å‰æ¸²æŸ“"><a href="#é‡ç”¨-Chrome-å®ä¾‹å®ç°äº¤å‰æ¸²æŸ“" class="headerlink" title="é‡ç”¨ Chrome å®ä¾‹å®ç°äº¤å‰æ¸²æŸ“"></a>é‡ç”¨ Chrome å®ä¾‹å®ç°äº¤å‰æ¸²æŸ“</h3><p>æ¯æ¬¡é¢„æ¸²æŸ“éƒ½å¯åŠ¨æ–°çš„æµè§ˆå™¨ä¼šå¾ˆæµªè´¹ã€‚ç›¸åï¼Œä½ å¸Œæœ›åªå¯åŠ¨ä¸€ä¸ªå®ä¾‹ï¼Œç„¶ååœ¨å¤šä¸ªé¡µé¢æ¸²æŸ“æ—¶é‡ç”¨å®ƒã€‚</p>
<p>Puppeteer å¯ä»¥é€šè¿‡è°ƒç”¨ <a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md#puppeteerconnectoptions" target="_blank" rel="noopener"><code>puppeteer.connect()</code></a>ï¼Œè¿æ¥åˆ°ä¸€ä¸ªå·²æœ‰çš„ Chrome å®ä¾‹ï¼Œå®ƒæ¥æ”¶å®ä¾‹çš„è¿œç¨‹è°ƒè¯• URL ä½œä¸ºå‚æ•°ã€‚ä¸ºä¿è¯æµè§ˆå™¨å®ä¾‹çš„é•¿æ—¶é—´è¿è¡Œï¼Œæˆ‘ä»¬å¯ä»¥å°† <code>ssr()</code> å‡½æ•°å¯åŠ¨ Chrome è¿™éƒ¨åˆ†ä»£ç ç§»åˆ° Express æœåŠ¡å™¨é‡Œã€‚</p>
<p><strong>server.mjs</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import express from &apos;express&apos;;</span><br><span class="line">import puppeteer from &apos;puppeteer&apos;;</span><br><span class="line">import ssr from &apos;./ssr.mjs&apos;;</span><br><span class="line"></span><br><span class="line">let browserWSEndpoint = null;</span><br><span class="line">const app = express();</span><br><span class="line"></span><br><span class="line">app.get(&apos;/&apos;, async (req, res, next) =&gt; &#123;</span><br><span class="line">  if (!browserWSEndpoint) &#123;</span><br><span class="line">    const browser = await puppeteer.launch();</span><br><span class="line">    browserWSEndpoint = await browser.wsEndpoint();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const url = `$&#123;req.protocol&#125;://$&#123;req.get(&apos;host&apos;)&#125;/index.html`;</span><br><span class="line">  const &#123;html&#125; = await ssr(url, browserWSEndpoint);</span><br><span class="line"></span><br><span class="line">  return res.status(200).send(html);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>ssr.mjs</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import puppeteer from &apos;puppeteer&apos;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @param &#123;string&#125; url URL to prerender.</span><br><span class="line"> * @param &#123;string&#125; browserWSEndpoint Optional remote debugging URL. If</span><br><span class="line"> *     provided, Puppeteer&apos;s reconnects to the browser instance. Otherwise,</span><br><span class="line"> *     a new browser instance is launched.</span><br><span class="line"> */</span><br><span class="line">async function ssr(url, browserWSEndpoint) &#123;</span><br><span class="line">  ...</span><br><span class="line">  console.info(&apos;Connecting to existing Chrome instance.&apos;);</span><br><span class="line">  const browser = await puppeteer.connect(&#123;browserWSEndpoint&#125;);</span><br><span class="line"></span><br><span class="line">  const page = await browser.newPage();</span><br><span class="line">  ...</span><br><span class="line">  await page.close(); // Close the page we opened here (not the browser).</span><br><span class="line"></span><br><span class="line">  return &#123;html&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ä¾‹å­ï¼šå®ç°å‘¨æœŸæ€§é¢„æ¸²æŸ“çš„å®šæ—¶ä»»åŠ¡"><a href="#ä¾‹å­ï¼šå®ç°å‘¨æœŸæ€§é¢„æ¸²æŸ“çš„å®šæ—¶ä»»åŠ¡" class="headerlink" title="ä¾‹å­ï¼šå®ç°å‘¨æœŸæ€§é¢„æ¸²æŸ“çš„å®šæ—¶ä»»åŠ¡"></a>ä¾‹å­ï¼šå®ç°å‘¨æœŸæ€§é¢„æ¸²æŸ“çš„å®šæ—¶ä»»åŠ¡</h4><p>åœ¨ <a href="https://devwebfeed.appspot.com/ssr" target="_blank" rel="noopener">App å¼•æ“é¢æ¿åº”ç”¨</a> é‡Œï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ª<a href="https://cloud.google.com/appengine/docs/flexible/nodejs/scheduling-jobs-with-cron-yaml" target="_blank" rel="noopener">å®šæ—¶å¤„ç†å™¨</a>ï¼Œæ¥å‘¨æœŸæ€§çš„é‡å¤æ¸²æŸ“æ’åå‰å‡ ä½çš„é¡µé¢ã€‚å¸®åŠ©ç”¨æˆ·å¿«é€Ÿçœ‹åˆ°æœ€æ–°å†…å®¹ï¼Œä»–ä»¬æ ¹æœ¬æ„ŸçŸ¥ä¸åˆ°ä¸€ä¸ªæ–°é¡µé¢çš„å¯åŠ¨æ€§èƒ½æ¶ˆè€—ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç”Ÿæˆå¤šä¸ª Chrome å®ä¾‹ä¼šå¾ˆæµªè´¹ã€‚ç›¸åï¼Œæˆ‘ç”¨äº†ä¸€ä¸ªå…±äº«çš„æµè§ˆå™¨å®ä¾‹æ¥ä¸€æ¬¡æ€§æ¸²æŸ“è¿™äº›é¡µé¢ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import puppeteer from &apos;puppeteer&apos;;</span><br><span class="line">import * as prerender from &apos;./ssr.mjs&apos;;</span><br><span class="line">import urlModule from &apos;url&apos;;</span><br><span class="line">const URL = urlModule.URL;</span><br><span class="line"></span><br><span class="line">app.get(&apos;/cron/update_cache&apos;, async (req, res) =&gt; &#123;</span><br><span class="line">  if (!req.get(&apos;X-Appengine-Cron&apos;)) &#123;</span><br><span class="line">    return res.status(403).send(&apos;Sorry, cron handler can only be run as admin.&apos;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const browser = await puppeteer.launch();</span><br><span class="line">  const homepage = new URL(`$&#123;req.protocol&#125;://$&#123;req.get(&apos;host&apos;)&#125;`);</span><br><span class="line"></span><br><span class="line">  // Re-render main page and a few pages back.</span><br><span class="line">  prerender.clearCache();</span><br><span class="line">  await prerender.ssr(homepage.href, await browser.wsEndpoint());</span><br><span class="line">  await prerender.ssr(`$&#123;homepage&#125;?year=2018`);</span><br><span class="line">  await prerender.ssr(`$&#123;homepage&#125;?year=2017`);</span><br><span class="line">  await prerender.ssr(`$&#123;homepage&#125;?year=2016`);</span><br><span class="line">  await browser.close();</span><br><span class="line"></span><br><span class="line">  res.status(200).send(&apos;Render cache updated!&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>æˆ‘è¿˜åœ¨ <strong>ssr.js</strong> export ä¸ŠåŠ äº†ä¸€ä¸ª <code>clearCache()</code> å‡½æ•°ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">function clearCache() &#123;</span><br><span class="line">  RENDER_CACHE.clear();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export &#123;ssr, clearCache&#125;;</span><br></pre></td></tr></table></figure>

<br>
## å…¶ä»–å› ç´ 
------------------------------------

<h3 id="å‘Šè¯‰é¡µé¢ï¼šâ€œä½ æ­£åœ¨è¢«æ— å¤´æµè§ˆå™¨æ¸²æŸ“â€"><a href="#å‘Šè¯‰é¡µé¢ï¼šâ€œä½ æ­£åœ¨è¢«æ— å¤´æµè§ˆå™¨æ¸²æŸ“â€" class="headerlink" title="å‘Šè¯‰é¡µé¢ï¼šâ€œä½ æ­£åœ¨è¢«æ— å¤´æµè§ˆå™¨æ¸²æŸ“â€"></a>å‘Šè¯‰é¡µé¢ï¼šâ€œä½ æ­£åœ¨è¢«æ— å¤´æµè§ˆå™¨æ¸²æŸ“â€</h3><p>å½“é¡µé¢æ­£åœ¨æœåŠ¡å™¨ä¸Šçš„æ— å¤´ Chrome ä¸­æ¸²æŸ“æ—¶ï¼Œå®¢æˆ·ç«¯é€»è¾‘å¾ˆæœ‰å¿…è¦çŸ¥é“è¿™ä¸€ä¿¡æ¯ã€‚æˆ‘çš„åº”ç”¨ä½¿ç”¨äº†é’©å­æ¥â€œå…³é—­â€éƒ¨åˆ†ä¸å‚ä¸æ¸²æŸ“ post èŠ‚ç‚¹çš„é¡µé¢ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ç¦ç”¨äº†æ‡’åŠ è½½ <a href="https://firebase.google.com/docs/web/setup" target="_blank" rel="noopener">firebase-auth.js</a> è¿™éƒ¨åˆ†ä»£ç ã€‚æ ¹æœ¬ä¸éœ€è¦ç”¨æˆ·ç™»å½•ï¼</p>
<p>åœ¨ URL ä¸ŠåŠ ä¸€ä¸ª <code>?headless</code> å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªç»™é¡µé¢åŠ é’©å­çš„ç®€å•æ–¹æ³•ï¼š</p>
<p><strong>ssr.mjs</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import urlModule from &apos;url&apos;;</span><br><span class="line">const URL = urlModule.URL;</span><br><span class="line"></span><br><span class="line">async function ssr(url) &#123;</span><br><span class="line">  ...</span><br><span class="line">  // Add ?headless to the URL so the page has a signal</span><br><span class="line">  // it&apos;s being loaded by headless Chrome.</span><br><span class="line">  const renderUrl = new URL(url);</span><br><span class="line">  renderUrl.searchParams.set(&apos;headless&apos;, &apos;&apos;);</span><br><span class="line">  await page.goto(renderUrl, &#123;waitUntil: &apos;networkidle0&apos;&#125;);</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  return &#123;html&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åœ¨é¡µé¢å†…æŸ¥è¯¢è¯¥å‚æ•°ï¼š</p>
<p><strong>public&#x2F;index.html</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div id=&quot;container&quot;&gt;</span><br><span class="line">    &lt;!-- Populated by the JS below. --&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">(async() =&gt; &#123;</span><br><span class="line">  const params = new URL(location.href).searchParams;</span><br><span class="line"></span><br><span class="line">  const RENDERING_IN_HEADLESS = params.has(&apos;headless&apos;);</span><br><span class="line">  if (RENDERING_IN_HEADLESS) &#123;</span><br><span class="line">    // Being rendered by headless Chrome on the server.</span><br><span class="line">    // e.g. shut off features, don&apos;t lazy load non-essential resources, etc.</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const container = document.querySelector(&apos;#container&apos;);</span><br><span class="line">  const posts = await fetch(&apos;/posts&apos;).then(resp =&gt; resp.json());</span><br><span class="line">  renderPosts(posts, container);</span><br><span class="line">&#125;)();</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>Tipï¼š<a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md#pageevaluateonnewdocumentpagefunction-args" target="_blank" rel="noopener"><code>Page.evaluateOnNewDocument()</code></a> ä¹Ÿå¯ä»¥æ–¹ä¾¿çš„æŸ¥è¯¢å‚æ•°ã€‚å®ƒä¼šåœ¨é¡µé¢ä¸­æ³¨å…¥ä»£ç ï¼Œè®© Puppeteer åœ¨é¡µé¢ä¸­å‰©ä½™å¾…æ‰§è¡Œçš„ JavaScript ä¹‹å‰è¿è¡Œè¿™äº›ä»£ç ã€‚</p>
<h3 id="é¿å…-PV-è†¨èƒ€"><a href="#é¿å…-PV-è†¨èƒ€" class="headerlink" title="é¿å… PV è†¨èƒ€"></a>é¿å… PV è†¨èƒ€</h3><p>ä½ å¦‚æœæ­£åœ¨é¡µé¢ä¸Šä½¿ç”¨åˆ†æå·¥å…·ï¼Œé‚£ä¹ˆè¦å°å¿ƒäº†ã€‚é¢„æ¸²æŸ“çš„é¡µé¢å¯èƒ½ä¼šé€ æˆ PV å‡ºç°è†¨èƒ€ã€‚å…·ä½“æ¥è¯´ï¼Œ<strong>æ‰“ç‚¹æ•°æ®å°†ä¼šæå‡2å€</strong>ï¼Œä¸€åŠæ˜¯åœ¨æ— å¤´ Chrome æ¸²æŸ“æ—¶ï¼Œå¦ä¸€åŠå‡ºç°åœ¨ç”¨æˆ·æµè§ˆå™¨æ¸²æŸ“æ—¶ã€‚</p>
<p>é‚£ä¹ˆæ€ä¹ˆä¿®å¤è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå°†æ‰€æœ‰åŠ è½½åˆ†æè„šæœ¬çš„è¯·æ±‚æ‹¦æˆªæ‰ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">page.on(&apos;request&apos;, req =&gt; &#123;</span><br><span class="line">  // Don&apos;t load Google Analytics lib requests so pageviews aren&apos;t 2x.</span><br><span class="line">  const blacklist = [&apos;www.google-analytics.com&apos;, &apos;/gtag/js&apos;, &apos;ga.js&apos;, &apos;analytics.js&apos;];</span><br><span class="line">  if (blacklist.find(regex =&gt; req.url().match(regex))) &#123;</span><br><span class="line">    return req.abort();</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  req.continue();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>ä»£ç ä¸åŠ è½½ï¼Œé¡µé¢è®¿é—®å°±ä¸ä¼šè¢«è®°å½•ã€‚çœŸ Skr ä¸ªæœºçµé¬¼ ğŸ’¥ã€‚</p>
<p>æˆ–è€…ï¼Œä½ ä¹Ÿå¯ä»¥ç»§ç»­åŠ è½½åˆ†æè„šæœ¬ï¼Œæ¥è·æ‚‰æœåŠ¡å™¨ä¸Šè¿è¡Œçš„é¢„æ¸²æŸ“å™¨æ•°ã€‚</p>
<br>

<h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><hr>
<p>Puppeteer é€šè¿‡è¿è¡Œæ— å¤´ Chromeï¼Œä¸è´¹å¹ç°ä¹‹åŠ›å°±å®ç°äº†æœåŠ¡ç«¯æ¸²æŸ“ã€‚<strong>æå‡åŠ è½½æ€§èƒ½</strong>å’Œ<strong>æ²¡æœ‰æ”¹åŠ¨å¤§é‡ä»£ç å°±å¢å¼ºäº†åº”ç”¨çš„å¯ç´¢å¼•æ€§</strong>ï¼Œæ˜¯è¿™ä¸ªæ–¹æ¡ˆä¸­æˆ‘æœ€å–œæ¬¢çš„â€œç‰¹æ€§â€ã€‚</p>
<p><strong>æ³¨æ„ï¼š</strong> å¦‚æœä½ å¯¹æ–‡ç« ä¸­æè¿°çš„æŠ€æœ¯æ„Ÿå…´è¶£ï¼Œå¯ä»¥å»çœ‹çœ‹<a href="https://devwebfeed.appspot.com/ssr" target="_blank" rel="noopener">è¿™ä¸ªåº”ç”¨</a>ï¼Œä»¥åŠ<a href="https://github.com/ebidel/devwebfeed/blob/master/server.mjs" target="_blank" rel="noopener">å®ƒçš„ä»£ç </a>ã€‚</p>
<br>

<h2 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h2><hr>
<h3 id="ç°æœ‰æŠ€æœ¯çš„è®¨è®º"><a href="#ç°æœ‰æŠ€æœ¯çš„è®¨è®º" class="headerlink" title="ç°æœ‰æŠ€æœ¯çš„è®¨è®º"></a>ç°æœ‰æŠ€æœ¯çš„è®¨è®º</h3><p>å¾ˆéš¾åœ¨æœåŠ¡ç«¯ä¸Šæ¸²æŸ“å®¢æˆ·ç«¯åº”ç”¨ã€‚æœ‰å¤šéš¾ï¼Ÿå»çœ‹çœ‹å¤§å®¶ç»™è¿™ä¸ªè¯é¢˜å¥‰çŒ®äº†å¤šå°‘ä¸ª <a href="https://www.npmjs.com/search?q=server%20side%20rendering" target="_blank" rel="noopener">npm åŒ…</a>å°±çŸ¥é“äº†ã€‚æœ‰æ•°ä¸æ¸…çš„<a href="https://en.wikipedia.org/wiki/Isomorphic_JavaScript" target="_blank" rel="noopener">æ¨¡å¼</a>ï¼Œ<a href="https://github.com/GoogleChrome/rendertron" target="_blank" rel="noopener">å·¥å…·</a>ï¼Œå’Œ<a href="https://prerender.io/" target="_blank" rel="noopener">æœåŠ¡</a>æ¥è¾…åŠ©æœåŠ¡ç«¯æ¸²æŸ“çš„ JS åº”ç”¨ã€‚</p>
<h4 id="åŒæ„-JavaScript"><a href="#åŒæ„-JavaScript" class="headerlink" title="åŒæ„ JavaScript"></a>åŒæ„ JavaScript</h4><p>åŒæ„ JavaScript çš„æ¦‚å¿µå¾ˆç®€å•ï¼šåŒæ ·çš„ä»£ç æ—¢èƒ½åœ¨æœåŠ¡ç«¯è¿è¡Œï¼Œä¹Ÿèƒ½åœ¨å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰è¿è¡Œã€‚æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å…±äº«ä»£ç ï¼Œç¾æ»‹æ»‹ï¼</p>
<p>å®è·µä¸­ï¼Œæˆ‘å‘ç°åŒæ„ JS å¾ˆéš¾å®ç°ã€‚è¿™æ˜¯æˆ‘è‡ªå·±çš„é—®é¢˜â€¦</p>
<blockquote>
<p>æˆ‘æœ€è¿‘å¼€å§‹åšä¸€ä¸ª<a href="https://github.com/ebidel/devwebfeed/blob/master/server.mjs" target="_blank" rel="noopener">é¡¹ç›®</a>ï¼Œå°è¯•ä¸‹ <a href="https://github.com/Polymer/lit-html" target="_blank" rel="noopener">lit-html</a>ã€‚Lit æ˜¯ä¸€ä¸ªä¼˜ç§€çš„åº“ï¼Œå®ƒå¯ä»¥å…è®¸ä½ å†™ä½¿ç”¨ JS æ¨¡æ¿å­—ç¬¦ä¸²å†™ <a href="https://www.html5rocks.com/en/tutorials/webcomponents/template/" target="_blank" rel="noopener">HTML &lt;template&gt;</a>ï¼Œç„¶åé«˜æ•ˆåœ°å°†è¿™äº›æ¨¡æ¿æ¸²æŸ“ä¸º DOMã€‚é—®é¢˜æ˜¯å®ƒçš„æ ¸å¿ƒç‰¹æ€§ï¼ˆä½¿ç”¨ <code>&lt;template&gt;</code> å…ƒç´ ï¼‰åªèƒ½åœ¨æµè§ˆå™¨ä¸Šå·¥ä½œã€‚è¿™æ„å‘³ç€å®ƒåœ¨ Node æœåŠ¡å™¨ä¸Šä¸èƒ½è¿è¡Œã€‚æˆ‘å¸Œæœ› Node å’Œå‰ç«¯å…±äº«çš„ SSR ä»£ç èƒ½å¤Ÿè„±ç¦» window å¯¹è±¡ã€‚</p>
</blockquote>
<blockquote>
<p>æœ€åæˆ‘æ„è¯†åˆ°å¯ä»¥ä½¿ç”¨æ— å¤´ Chrome æ¥æœåŠ¡ç«¯æ¸²æŸ“åº”ç”¨ï¼ŒChrome æ˜¯ç»ç”¨æˆ·çš„æ‰‹è¿è¡Œæˆ–æ˜¯åœ¨æœåŠ¡å™¨ä¸Šè‡ªåŠ¨è¿è¡Œå¹¶ä¸é‡è¦ï¼Œå®ƒåæ­£æ˜¯æ„‰å¿«åœ°æ‰§è¡Œäº†æ‰€æœ‰ JSã€‚ä¸è¦å¤šé—®ã€‚ </p>
</blockquote>
<p>æ— å¤´ Chrome åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¸Šå¯ç”¨ â€œåŒæ„ JSâ€ã€‚å®ƒå¯¹äºå½“å‰åº“ä¸æ”¯æŒæœåŠ¡ç«¯ï¼ˆNodeï¼‰ç»™å‡ºäº†ä¸€ä¸ªä¸é”™çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<h4 id="é¢„æ¸²æŸ“å·¥å…·"><a href="#é¢„æ¸²æŸ“å·¥å…·" class="headerlink" title="é¢„æ¸²æŸ“å·¥å…·"></a>é¢„æ¸²æŸ“å·¥å…·</h4><p>Node ç¤¾åŒºå·²ç»è¯ç”Ÿäº†å¥½å‡ å¨è§£å†³æœåŠ¡ç«¯æ¸²æŸ“ JS åº”ç”¨çš„å·¥å…·ã€‚æ¯«æ— æ–°æ„ï¼ä¸ªäººè€Œè¨€ï¼Œæˆ‘å‘ç°å„äººå¯¹äºè¿™äº›å·¥å…·çš„ä½“ä¼šå¯èƒ½ä¸åŒï¼Œæ‰€ä»¥ä½¿ç”¨è¿™äº›å·¥å…·å‰è‚¯å®šè¦åšå¥½åŠŸè¯¾ã€‚æ¯”å¦‚è¯´ï¼Œä¸€äº›æœåŠ¡ç«¯æ¸²æŸ“å·¥å…·æ¯”è¾ƒè€ï¼Œå¹¶ä¸”æ²¡æœ‰ä½¿ç”¨æ— å¤´ Chromeï¼ˆæˆ–è€…ä»»ä½•å…¶ä»–æ— å¤´æµè§ˆå™¨ï¼‰ã€‚ç›¸åï¼Œå®ƒä»¬ä½¿ç”¨ PhantomJSï¼ˆåˆåæ—§ Safariï¼‰ï¼Œè¿™æ„å‘³ç€ä½¿ç”¨æ–°ç‰¹æ€§æ—¶é¡µé¢ä¸ä¼šæ­£ç¡®æ¸²æŸ“ã€‚</p>
<p>ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„ä¾‹å¤–æ˜¯ <a href="https://github.com/prerender/prerender/" target="_blank" rel="noopener">Prerender</a>ã€‚Prerender ä½¿ç”¨äº†æ— å¤´ Chrome å’Œ <a href="https://github.com/prerender/prerender-node" target="_blank" rel="noopener">Express ä¸­é—´ä»¶</a>ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const prerender =  require(&apos;prerender&apos;);  </span><br><span class="line">const server = prerender();  </span><br><span class="line">server.use(prerender.removeScriptTags());  </span><br><span class="line">server.use(prerender.blockResources());  </span><br><span class="line">server.start();</span><br></pre></td></tr></table></figure>

<p>Prerender çœå»äº†è·¨å¹³å°ä¸‹è½½å’Œå®‰è£… Chrome çš„æ‰€æœ‰ç»†èŠ‚ã€‚è¦æ­£ç¡®å®Œæˆè¿™ä¸€è¿‡ç¨‹é€šå¸¸æ˜¯ç›¸å½“æ£˜æ‰‹çš„ï¼Œè¿™ä¹Ÿæ˜¯ <a href="https://developers.google.com/web/tools/puppeteer/faq#q_which_chromium_version_does_puppeteer_use" target="_blank" rel="noopener">Puppeteer</a> å­˜åœ¨çš„åŸå› ä¹‹ä¸€ã€‚æˆ‘ä¹Ÿæäº†ä¸€äº›æ¸²æŸ“æˆ‘çš„éƒ¨åˆ†åº”ç”¨çš„ issueã€‚</p>
<p><img src="https://mares.oss-cn-qingdao.aliyuncs.com/blog/Puppeteer/1.png" alt="æµè§ˆå™¨ä¸­æ¸²æŸ“çš„ Chrome çŠ¶æ€"></p>
<p><img src="https://mares.oss-cn-qingdao.aliyuncs.com/blog/Puppeteer/2.png" alt="prerender æ¸²æŸ“çš„ Chrome çŠ¶æ€"></p>

    </div>

</div>
                <div class="footer">
    <span>Copyright Â© 2022 Lynx</span>
    <span>Theme Designed By <a target="_blank" href="https://zheli.design/one-paper">é€™Li</a></span>
</div>

<link rel="stylesheet" href="/css/a11y-dark.min.css">
<script src="/js/highlight.min.js"></script>
<script src="/js/highlightjs-line-numbers.js"></script>

<script>
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
</script>

            </div>
        </div>
        <script>
            var _hmt = _hmt || [];
            (function() {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?be4f38e2c43dbecf025baf47c07262a6";
                var s = document.getElementsByTagName("script")[0]; 
                s.parentNode.insertBefore(hm, s);
            })();
        </script>
    </body>
</html>